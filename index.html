  <!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â„ï¸ Winterwarn-App Schweiz â€“ Komplett</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body{font-family:system-ui;background:#0f172a;color:#e5e7eb;margin:0;padding:16px}
h1{font-size:1.6rem}
.card{background:#020617;border-radius:16px;padding:16px;margin-top:16px;box-shadow:0 10px 25px rgba(0,0,0,.4)}
select,input,button{width:100%;padding:10px;border-radius:10px;border:none;margin-top:6px;font-size:1rem}
button{background:#2563eb;color:white;font-weight:600;cursor:pointer}
button:disabled{background:#334155;cursor:not-allowed}
.status{margin-top:8px;font-size:.95rem}
.ampel{font-size:1.3rem;margin-top:8px}
.green{color:#22c55e}.yellow{color:#eab308}.orange{color:#fb923c}.red{color:#ef4444}
#map{width:100%;height:300px;margin-top:14px;border-radius:12px}
.blink{background-color:red;animation:blink-animation 0.5s steps(2,start) infinite}
@keyframes blink-animation{to{visibility:hidden}}
</style>
</head>
<body>
<h1>â„ï¸ Winterwarn-App Schweiz</h1>

<div class="card" id="alarmCard">
<h3>ğŸ“ Ort auswÃ¤hlen</h3>
<select id="location"></select>
<button onclick="requestLocation()">ğŸ“Œ Standortzugriff aktivieren</button>
<div id="ampel" class="ampel">Status: â€“</div>
<div id="index" class="status">Status wird geprÃ¼ftâ€¦</div>
<div id="trend" class="status"></div>
<div id="today" class="status"></div>
<div id="tomorrow" class="status"></div>
<div id="countdown" class="status"></div>
<div id="kanton" class="status"></div>
<div id="school" class="status"></div>
<button id="checkNow">ğŸ”„ Jetzt prÃ¼fen</button>
<div id="status" class="status">Status: nicht aktiv</div>
</div>

<div class="card">
<h3>ğŸ“§ E-Mail-EmpfÃ¤nger (max. 15)</h3>
<input id="emails" placeholder="email1@gmail.com, email2@gmail.com">
</div>

<div class="card">
<h3>ğŸš† Ã–V-Risiko</h3>
<div id="ov">â€“</div>
</div>

<div class="card">
<h3>ğŸ—ºï¸ Schneekarte Schweiz</h3>
<div id="map"></div>
</div>

<audio id="alarmSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxETt5pEIsHFU19u2IL1ouZ_crteiaepipClCflXxjDhDUEvYH_-BaJFBAJQCntdZy_/exec";
let initialMailSent=false;

const LOCATIONS=[
{name:'Ettiswil',lat:47.15,lon:8.02},
{name:'Luzern',lat:47.05,lon:8.31},
{name:'Sursee',lat:47.16,lon:8.04},
{name:'Sempach',lat:47.16,lon:8.12},
{name:'St. Urban',lat:47.12,lon:7.99},
{name:'Emmen',lat:47.08,lon:8.30}
];

const locationSelect=document.getElementById('location');
LOCATIONS.forEach(l=>{let o=document.createElement('option');o.value=l.name;o.textContent=l.name;locationSelect.appendChild(o);});

const ampelEl=document.getElementById('ampel');
const ovEl=document.getElementById('ov');
const emailInput=document.getElementById('emails');
const alarmCard=document.getElementById('alarmCard');
const alarmSound=document.getElementById('alarmSound');

const map=L.map('map').setView([47.05,8.15],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let heatLayer=L.heatLayer([],{radius:25}).addTo(map);
let markers=[];
LOCATIONS.forEach(l=>{let m=L.circleMarker([l.lat,l.lon],{radius:8,color:'blue'}).addTo(map);markers.push({m,l});});

function updateAmpel(level){
  ampelEl.className='ampel '+level;
  ampelEl.textContent={green:'ğŸŸ¢ GRÃœN',yellow:'ğŸŸ¡ GELB',orange:'ğŸŸ  ORANGE',red:'ğŸ”´ ROT'}[level];
}

async function checkWeather(){
  let worst='green';
  let heat=[];
  for(const obj of markers){
    const {l,m}=obj;
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&hourly=snowfall,temperature_2m,windgusts_10m&forecast_days=2`);
    const d=await r.json();
    let snow=0,temp=99,wind=0;
    for(let i=0;i<24;i++){
      snow+=d.hourly.snowfall[i]||0;
      temp=Math.min(temp,d.hourly.temperature_2m[i]);
      wind=Math.max(wind,d.hourly.windgusts_10m[i]);
    }
    let level='green';
    if(snow>=20&&temp<=0&&wind>=50) level='red';
    else if(snow>=10) level='orange';
    else if(snow>=5) level='yellow';
    m.setStyle({color:level});
    heat.push([l.lat,l.lon,snow/20]);
    if(level==='red'||(level==='orange'&&worst!=='red')||(level==='yellow'&&worst==='green')) worst=level;
    if(locationSelect.value===l.name) updateAmpel(level);
  }
  heatLayer.setLatLngs(heat);
  ovEl.textContent={green:'ğŸŸ¢ Normal',yellow:'ğŸŸ¡ leichte StÃ¶rungen',orange:'ğŸŸ  VerspÃ¤tungen',red:'ğŸ”´ AusfÃ¤lle'}[worst];

  if(!initialMailSent){
    sendEmails(worst);
    initialMailSent=true;
  }

  return worst;
}

function sendEmails(level){
  const emails=emailInput.value.split(',').map(e=>e.trim()).filter(e=>e).slice(0,15);
  if(!emails.length) return;
  fetch(SCRIPT_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      location:locationSelect.value,
      level:level,
      emails:emails,
      type:'Automatische Analyse',
      start:'Jetzt',peak:'Aktuell',end:'NÃ¤chste Stunden',
      snow:'â€“',temp:'â€“',ov:ovEl.textContent,school:'â€“'
    })
  });
}

document.getElementById('checkNow').onclick=async()=>{
  const lvl=await checkWeather();
  if(lvl==='red'){alarmCard.classList.add('blink');alarmSound.play().catch(()=>{});} 
  else{alarmCard.classList.remove('blink');alarmSound.pause();}
};

checkWeather();
setInterval(checkWeather,60000);
</script>
</body>
</html>
