  <!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â„ï¸ Winterwarn-App Schweiz â€“ Test</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body{font-family:system-ui;background:#0f172a;color:#e5e7eb;margin:0;padding:16px}
h1{font-size:1.6rem}
.card{background:#020617;border-radius:16px;padding:16px;margin-top:16px;box-shadow:0 10px 25px rgba(0,0,0,.4)}
select,input,button{width:100%;padding:10px;border-radius:10px;border:none;margin-top:6px;font-size:1rem}
button{background:#2563eb;color:white;font-weight:600;cursor:pointer}
button:disabled{background:#334155;cursor:not-allowed}
.status{margin-top:8px;font-size:.95rem}
.ampel{font-size:1.3rem;margin-top:8px}
.green{color:#22c55e}.yellow{color:#eab308}.orange{color:#fb923c}.red{color:#ef4444}
#map{width:100%;height:300px;margin-top:14px;border-radius:12px}
.blink{background-color:red;animation:blink-animation 0.5s steps(2,start) infinite}
@keyframes blink-animation{to{visibility:hidden}}
.legend{background:rgba(0,0,0,0.7);padding:6px 10px;border-radius:8px;color:white;line-height:1.4;margin-top:10px}
.legend div{display:flex;align-items:center;margin-bottom:4px}
.legend span{display:inline-block;width:16px;height:16px;margin-right:6px;border-radius:4px}
</style>
</head>
<body>
<h1>â„ï¸ Winterwarn-App Schweiz</h1>

<div class="card" id="alarmCard">
<h3>ğŸ“ Ort auswÃ¤hlen</h3>
<select id="location"></select>
<div id="ampel" class="ampel">Status: â€“</div>
<div id="status" class="status">Status wird geprÃ¼ftâ€¦</div>
<button id="checkNow">ğŸ”„ Jetzt prÃ¼fen</button>
</div>

<div class="card">
<h3>ğŸ“§ E-Mail-EmpfÃ¤nger (max. 15, Komma getrennt)</h3>
<input id="emails" placeholder="email1@gmail.com, email2@gmail.com">
</div>

<div class="card">
<h3>ğŸš† Ã–V-Risiko</h3>
<div id="ov">â€“</div>
</div>

<div class="card">
<h3>ğŸ—ºï¸ Schneekarte Schweiz (Heatmap)</h3>
<div id="map"></div>
<div class="legend">
<div><span style="background:green"></span>Geringe Gefahr</div>
<div><span style="background:yellow"></span>ErhÃ¶hte Gefahr</div>
<div><span style="background:orange"></span>Hohe Gefahr</div>
<div><span style="background:red"></span>Sehr hohe Gefahr</div>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxETt5pEIsHFU19u2IL1ouZ_crteiaepipClCflXxjDhDUEvYH_-BaJFBAJQCntdZy_/exec";

const LOCATIONS=[
{name:'Ettiswil',lat:47.15,lon:8.02},
{name:'Luzern',lat:47.05,lon:8.31},
{name:'Sursee',lat:47.16,lon:8.04},
{name:'Sempach',lat:47.16,lon:8.12},
{name:'St. Urban',lat:47.12,lon:7.99},
{name:'Emmen',lat:47.08,lon:8.30},
{name:'Kriens',lat:47.03,lon:8.28},
{name:'Horw',lat:47.02,lon:8.31},
{name:'Ebikon',lat:47.08,lon:8.34},
{name:'Willisau',lat:47.12,lon:7.99},
{name:'Hochdorf',lat:47.17,lon:8.29},
{name:'Malters',lat:47.04,lon:8.18},
{name:'Wolhusen',lat:47.06,lon:8.08},
{name:'Ruswil',lat:47.08,lon:8.13},
{name:'SchÃ¼pfheim',lat:46.95,lon:8.02}
];

const locationSelect=document.getElementById('location');
LOCATIONS.forEach(loc=>{
  const opt=document.createElement('option'); opt.value=loc.name; opt.textContent=loc.name;
  locationSelect.appendChild(opt);
});

const ampelEl=document.getElementById('ampel');
const statusEl=document.getElementById('status');
const ovEl=document.getElementById('ov');
const emailInput=document.getElementById('emails');

const map=L.map('map').setView([47.05,8.15],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
let markers=[];
LOCATIONS.forEach(loc=>{
  const m=L.circleMarker([loc.lat,loc.lon],{radius:10,color:'blue'}).addTo(map);
  m.bindPopup(`${loc.name}<br>LÃ¤dtâ€¦`);
  markers.push({marker:m,loc:loc});
});
let heatLayer=L.heatLayer([],{radius:25,blur:15,maxZoom:17}).addTo(map);

function updateAmpel(level){
  ampelEl.className='ampel '+level;
  switch(level){
    case 'green': ampelEl.textContent='ğŸŸ¢ GRÃœN â€“ keine Gefahr'; break;
    case 'yellow': ampelEl.textContent='ğŸŸ¡ GELB â€“ erhÃ¶hte Gefahr'; break;
    case 'orange': ampelEl.textContent='ğŸŸ  ORANGE â€“ starke Gefahr'; break;
    case 'red': ampelEl.textContent='ğŸ”´ ROT â€“ EXTREME Gefahr'; break;
  }
}

async function checkWeather(){
  statusEl.textContent='Status: prÃ¼fe Wetterdatenâ€¦';
  try{
    let heatData=[];
    let worstOvLevel='green';
    let alarmActive=false;

    for(let i=0;i<markers.length;i++){
      const loc=markers[i].loc; const m=markers[i].marker;
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=snowfall,temperature_2m,windgusts_10m&forecast_days=3`;
      const res=await fetch(url); const data=await res.json();
      if(!data||!data.hourly) continue;

      let snow=0, wind=0, minTemp=99;
      for(let h=0;h<48;h++){
        snow+=data.hourly.snowfall[h]||0;
        wind=Math.max(wind,data.hourly.windgusts_10m[h]||0);
        minTemp=Math.min(minTemp,data.hourly.temperature_2m[h]||99);
      }

      // Farbe bestimmen
      let color='green';
      if(snow>=20 && wind>=50 && minTemp<=0){ color='red'; alarmActive=true; }
      else if(snow>=10 || minTemp<=-2){ color='orange'; }
      else if(snow>=5){ color='yellow'; }

      if(color==='red') worstOvLevel='red';
      else if(color==='orange' && worstOvLevel!=='red') worstOvLevel='orange';
      else if(color==='yellow' && worstOvLevel==='green') worstOvLevel='yellow';

      m.setStyle({color:color});
      m.setPopupContent(`${loc.name}<br>Schnee: ${snow.toFixed(1)}cm<br>Wind: ${wind.toFixed(1)} km/h<br>Temp: ${minTemp.toFixed(1)}Â°C`);
      heatData.push([loc.lat,loc.lon,snow/50]);

      if(locationSelect.value===loc.name) updateAmpel(color);
    }

    heatLayer.setLatLngs(heatData);

    // Ã–V-Risiko
    switch(worstOvLevel){
      case 'green': ovEl.textContent='ğŸŸ¢ Ã–V: Normalbetrieb'; break;
      case 'yellow': ovEl.textContent='ğŸŸ¡ Ã–V: kleinere VerspÃ¤tungen mÃ¶glich'; break;
      case 'orange': ovEl.textContent='ğŸŸ  Ã–V: starke VerspÃ¤tungen & AusfÃ¤lle mÃ¶glich'; break;
      case 'red': ovEl.textContent='ğŸ”´ Ã–V: hoher Ausfall-Risiko â€“ Fahrten vermeiden'; break;
    }

    statusEl.textContent='Status: letzte PrÃ¼fung erfolgreich';

    // Mail sofort senden
    sendEmails(locationSelect.value);

    return alarmActive;
  } catch(e){
    statusEl.textContent='âš ï¸ Fehler beim Laden der Wetterdaten';
    console.error(e);
    return false;
  }
}

function sendEmails(location){
  const emails=emailInput.value.split(',').map(e=>e.trim()).filter(e=>e).slice(0,15);
  if(emails.length===0) return;

  const payload={level:'green',location:location,emails:emails,type:'Winter',start:'â€“',peak:'â€“',end:'â€“',snow:'â€“',temp:'â€“',ov:'â€“',school:'â€“'};

  fetch(SCRIPT_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(r=>r.text()).then(t=>console.log('Mail-Status:',t)).catch(e=>console.error(e));
}

// Event: Button prÃ¼fen
document.getElementById('checkNow').onclick=checkWeather;

// Sofort beim Laden
window.onload=checkWeather;

</script>
</body>
</html>
